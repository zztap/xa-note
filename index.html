<!DOCTYPE html>
<html lang="zh-CN">

<head>
  <meta charset="UTF-8" />

  <!-- 基础SEO -->
  <title>Loading...</title>
  <meta name="description"
    content="XA Note是一款现代化的智能笔记管理系统，支持Markdown编辑、分类管理、标签系统、全文搜索、WebDAV备份等功能。提供简洁优雅的界面，助您高效记录和管理知识。" />
  <meta name="keywords" content="笔记管理,Markdown编辑器,知识管理,笔记软件,在线笔记,云笔记,WebDAV备份,全文搜索,标签管理,分类整理" />
  <meta name="author" content="XA Note Team" />
  <meta name="robots" content="index, follow" />
  <meta name="language" content="zh-CN" />

  <!-- 视口和移动端优化 -->
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <meta name="format-detection" content="telephone=no" />
  <meta name="mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <meta name="apple-mobile-web-app-title" content="XA Note" />

  <!-- Open Graph / Facebook -->
  <meta property="og:type" content="website" />
  <meta property="og:url" content="/" />
  <meta property="og:title" content="XA Note - 智能笔记管理系统" />
  <meta property="og:description" content="现代化的智能笔记管理系统，支持Markdown编辑、分类管理、标签系统、全文搜索等功能。" />
  <meta property="og:image" content="//og-image.png" />
  <meta property="og:image:width" content="1200" />
  <meta property="og:image:height" content="630" />
  <meta property="og:site_name" content="XA Note" />
  <meta property="og:locale" content="zh_CN" />

  <!-- Twitter -->
  <meta property="twitter:card" content="summary_large_image" />
  <meta property="twitter:url" content="/" />
  <meta property="twitter:title" content="XA Note - 智能笔记管理系统" />
  <meta property="twitter:description" content="现代化的智能笔记管理系统，支持Markdown编辑、分类管理、标签系统、全文搜索等功能。" />
  <meta property="twitter:image" content="//twitter-image.png" />
  <meta property="twitter:creator" content="@xa_note" />

  <!-- 图标和主题 -->
  <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png" />
  <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png" />
  <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png" />
  <link rel="manifest" href="/manifest.json" />
  <meta name="theme-color" content="#3b82f6" />
  <meta name="msapplication-TileColor" content="#3b82f6" />
  <meta name="msapplication-config" content="/browserconfig.xml" />

  <!-- 预连接和DNS预解析 -->
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link rel="dns-prefetch" href="//api.github.com" />

  <!-- 结构化数据 -->
  <script type="application/ld+json">
    {
      "@context": "https://schema.org",
      "@type": "SoftwareApplication",
      "name": "XA Note",
      "description": "轻量级自托管笔记系统，支持Markdown编辑、分类管理、标签系统、全文搜索、笔记分享、WebDAV备份等功能",
      "url": "//",
      "applicationCategory": "ProductivityApplication",
      "operatingSystem": "Web Browser",
      "offers": {
            "@type": "Offer",
            "price": "0",
            "priceCurrency": "USD"
      },
      "author": {
            "@type": "Organization",
            "name": "XiaoA"
      },
      "softwareVersion": "1.0.0",
      "datePublished": "2026-01-15",
      "screenshot": "//screenshot.png",
      "featureList": [
            "Markdown编辑器",
            "分类管理",
            "标签系统",
            "全文搜索",
            "WebDAV备份",
            "多语言支持",
            "暗黑模式",
            "响应式设计"
      ]
}
    </script>

  <!-- 安全和隐私 -->
  <meta http-equiv="X-Content-Type-Options" content="nosniff" />
  <meta http-equiv="X-XSS-Protection" content="1; mode=block" />
  <meta http-equiv="Referrer-Policy" content="strict-origin-when-cross-origin" />

  <!-- 缓存控制 -->
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
  <meta http-equiv="Pragma" content="no-cache" />
  <meta http-equiv="Expires" content="0" />

  <!-- XA Note Share Page Handler -->
  <!-- MUST be before the React module script to prevent React from loading on share pages -->
  <script src="/share-handler.js?v=3"></script>

  <script type="module" crossorigin src="/assets/index-CfJzE6qT.js"></script>
  <!-- Premium UI Enhancement -->
  <link rel="stylesheet" crossorigin href="/assets/index-Czj62kEc.css">
  <link rel="stylesheet" href="/beautify.css">
</head>

<body>
  <!-- Splash Screen -->
  <div id="loader-wrapper">
    <div id="loader">
      <div class="loader-logo">
        <svg viewBox="0 0 100 100" width="80" height="80">
          <defs>
            <linearGradient id="grad1" x1="0%" y1="0%" x2="100%" y2="100%">
              <stop offset="0%" style="stop-color:#3b82f6;stop-opacity:1" />
              <stop offset="100%" style="stop-color:#1d4ed8;stop-opacity:1" />
            </linearGradient>
          </defs>
          <path d="M20 20 L80 20 L80 80 L20 80 Z" fill="none" stroke="url(#grad1)" stroke-width="8"
            stroke-linejoin="round" />
          <path d="M35 40 L65 40 M35 50 L65 50 M35 60 L50 60" stroke="#3b82f6" stroke-width="6"
            stroke-linecap="round" />
        </svg>
      </div>
      <div class="loader-text">XA Note</div>
      <div class="loader-progress">
        <div class="loader-progress-bar"></div>
      </div>
    </div>
  </div>

  <div id="root"></div>

  <script>
    // 渐进式隐藏启动页
    window.addEventListener('load', () => {
      const wrapper = document.getElementById('loader-wrapper');
      if (wrapper) {
        // 给一点额外的时间让首屏渲染更丝滑
        setTimeout(() => {
          wrapper.classList.add('loaded');
          // 动画结束后彻底移除，减少 DOM 压力
          setTimeout(() => wrapper.remove(), 800);
        }, 500);
      }
    });

    // 备用方案：如果由于某种原因 load 事件没触发，或者耗时太久
    setTimeout(() => {
      const wrapper = document.getElementById('loader-wrapper');
      if (wrapper) {
        wrapper.classList.add('loaded');
        setTimeout(() => wrapper.remove(), 800);
      }
    }, 5000);

    // 日志管理能力修复脚本 (注入 UI 按钮)
    (function () {
      function injectLogDeleteButton() {
        // 定位日志弹窗
        const modal = Array.from(document.querySelectorAll('div')).find(el =>
          el.classList.contains('fixed') && el.textContent.includes('日志') && el.querySelector('.fa-xmark, svg')
        );
        if (!modal) return;

        // 定位重置按钮
        const buttons = Array.from(modal.querySelectorAll('button'));
        const resetButton = buttons.find(b => b.textContent.trim() === '重置');
        if (!resetButton || modal.querySelector('.custom-clear-logs-btn')) return;

        const clearBtn = document.createElement('button');
        clearBtn.className = 'custom-clear-logs-btn bg-red-500 text-white px-4 py-2 rounded-md hover:bg-red-600 transition-all flex items-center justify-center';
        clearBtn.style.cssText = 'margin-left: 10px; background-color: #ef4444; color: white; padding: 6px 16px; border-radius: 6px; font-weight: 500; font-size: 14px;';
        clearBtn.textContent = '清空全部日志';

        clearBtn.onclick = async (e) => {
          e.preventDefault();
          if (confirm('⚠️ 确定要彻底清空所有操作日志吗？此操作无法撤销。')) {
            clearBtn.disabled = true;
            clearBtn.textContent = '清理中...';
            try {
              const res = await fetch('/api/logs/cleanup', {
                method: 'DELETE',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ days: 0 })
              });
              const data = await res.json();
              if (data.ok) {
                alert('Success: 日志已成功清空');
                location.reload();
              } else {
                alert('Error: ' + (data.error || '清理失败'));
              }
            } catch (err) {
              alert('Network Error: 无法连接至服务器');
            } finally {
              clearBtn.disabled = false;
              clearBtn.textContent = '清空全部日志';
            }
          }
        };

        resetButton.parentNode.appendChild(clearBtn);
      }

      // 持续监听 DOM 变动，确保弹窗载入时能注入
      const observer = new MutationObserver((mutations) => {
        for (const mutation of mutations) {
          if (mutation.addedNodes.length) injectLogDeleteButton();
        }
      });
      observer.observe(document.body, { childList: true, subtree: true });
    })();

    // 快捷键逻辑修复与行为拦截 (防止 Ctrl + K 刷新页面)
    window.addEventListener('keydown', (e) => {
      // 拦截 Ctrl + K 或 Cmd + K
      if ((e.ctrlKey || e.metaKey) && e.key.toLowerCase() === 'k') {
        e.preventDefault(); // 强行拦截默认行为

        // 尝试自动聚焦搜索框
        const searchInput = document.querySelector('input[placeholder*="搜索"]');
        if (searchInput) {
          searchInput.focus();
          // 如果不在侧边栏视口，可以尝试展开侧边栏（如果原程序支持）
        } else {
          // 如果弹窗没开，可以模拟点击搜索图标或按钮（如果能定位到）
          console.log('Search shortcut intercepted, but input not found.');
        }
      }

      // 额外保险：拦截 Ctrl + S 以防止触发系统保存弹窗
      if ((e.ctrlKey || e.metaKey) && e.key.toLowerCase() === 's') {
        // 通常原程序有处理，这里主要是二次保险，不强制 preventDefault 除非确定冲突
      }
    }, true); // 使用捕获阶段以获得最高优先权

    // 弹窗“传送门”修复脚本 (解决侧边栏裁剪问题)
    (function () {
      function teleportModals() {
        // 寻找侧边栏内部的固定定位弹窗 (快捷键面板等)
        const sidebar = document.querySelector('aside, .w-64');
        if (!sidebar) return;

        const floatingModals = sidebar.querySelectorAll('.fixed, [class*="fixed"]');
        floatingModals.forEach(modal => {
          // 只搬运那些需要完整显示的面板
          if (modal.textContent.includes('快捷键') || modal.classList.contains('shadow-lg')) {
            if (modal.parentElement !== document.body) {
              modal.classList.add('custom-portal-modal'); // 标记类名，供 CSS 增强 z-index
              document.body.appendChild(modal);
              console.log('Modal teleported to body.');
            }
          }
        });
      }

      // 监视器：持续盯着 DOM，一旦弹窗被创建就搬走
      const portalObserver = new MutationObserver((mutations) => {
        teleportModals();
      });
      portalObserver.observe(document.body, { childList: true, subtree: true });

      // 增加轮询频率
      setInterval(teleportModals, 200); // 200ms 检查一次
    })();

    // 笔记卡片彩色化脚本 (Stable & Neighbor-Aware Pastel Colors)
    (function () {
      function getHash(str) {
        let hash = 0;
        for (let i = 0; i < str.length; i++) {
          hash = ((hash << 5) - hash) + str.charCodeAt(i);
          hash |= 0;
        }
        return Math.abs(hash);
      }

      function applyStableColors() {
        const cards = Array.from(document.querySelectorAll('.note-item, .note-list-item'));
        let lastVariant = -1;

        cards.forEach((card) => {
          // 获取现有变体类名
          const currentVariantClass = Array.from(card.classList).find(c => c.startsWith('note-variant-'));

          // 获取核心内容 + 各种扰动特征 (长度、日期等)，使相似内容尽量分色
          const content = card.innerText || card.textContent || '';
          const salt = content.length + (card.querySelector('.text-xs')?.textContent?.length || 0);
          const hash = getHash(content.substring(0, 100) + salt);

          let variant = (hash % 6) + 1;

          // 邻位差异化逻辑：如果跟上面一张卡片撞色了，则循环位移
          if (variant === lastVariant) {
            variant = (variant % 6) + 1;
          }

          // 如果新计算的颜色与当前不同，或者没有颜色，则更新
          const newVariantClass = `note-variant-${variant}`;
          if (currentVariantClass !== newVariantClass) {
            if (currentVariantClass) card.classList.remove(currentVariantClass);
            card.classList.add(newVariantClass);
          }

          lastVariant = variant;
        });
      }

      // 监视：监测子节点变化和类名变化
      const colorObserver = new MutationObserver(() => applyStableColors());
      colorObserver.observe(document.body, {
        childList: true,
        subtree: true,
        attributes: true,
        attributeFilter: ['class']
      });

      applyStableColors();
      setInterval(applyStableColors, 1500);
    })();

    // 强力头像防裂补丁 (Avatar Auto-Fallback)
    // 监听全局图片加载错误，自动替换为本地 Logo
    window.addEventListener('error', (e) => {
      const target = e.target;
      if (target && target.tagName === 'IMG') {
        const src = target.src || '';
        // 仅针对头像相关的图片进行处理
        if (src.includes('gravatar.com') || src.includes('cravatar.cn') || target.alt?.toLowerCase().includes('avatar')) {
          // 防止死循环
          if (src.includes('/logo.png')) return;

          console.warn('Avatar load failed, falling back to local logo.', src);
          target.removeAttribute('srcset'); // 清除响应式源
          target.src = '/logo.png';
          target.onerror = null; // 清除内联错误处理
          target.style.backgroundColor = '#f0f9ff'; // 增加淡蓝背景
        }
      }
    }, true); // 必须开启捕获(capture)才能监听到 error 事件

    // ☢️ 核弹级域名重写 (Aggressive Avatar URL Rewriter)
    // 不管后端或前端存了什么，只要 DOM 里出现 gravatar.com，强制替换为 cravatar.cn
    (function aggressiveAvatarRedirect() {
      const replaceSrc = (img) => {
        if (img.src && img.src.includes('gravatar.com')) {
          // 保留 hash 和参数，只替换域名
          const newSrc = img.src.replace('gravatar.com', 'cravatar.cn');
          img.src = newSrc;
          // 标记已处理，防止反复触发（虽然 src 变了自然不再包含 gravatar）
          img.dataset.fixed = 'true';
        }
      };

      // 1. 扫描现有图片
      document.querySelectorAll('img').forEach(replaceSrc);

      // 2. 及其霸道地监听所有新图片
      new MutationObserver((mutations) => {
        mutations.forEach(m => {
          m.addedNodes.forEach(node => {
            if (node.nodeName === 'IMG') replaceSrc(node);
            if (node.querySelectorAll) node.querySelectorAll('img').forEach(replaceSrc);
          });
          // 同时也监听属性变化 (如 React 重新渲染导致 src 变化)
          if (m.type === 'attributes' && m.target.nodeName === 'IMG') {
            replaceSrc(m.target);
          }
        });
      }).observe(document.body, {
        childList: true,
        subtree: true,
        attributes: true,
        attributeFilter: ['src']
      });
    })();

    // 头像源自动迁移脚本 (Auto-Migrate to Cravatar)
    // 检测当前配置是否仍为 Gravatar，如果是，则自动修正为 Cravatar
    (async function migrateAvatarSource() {
      try {
        // 1. 获取当前设置
        const res = await fetch('/api/settings/public');
        const settings = await res.json();

        // 2. 检查是否需要迁移
        const currentPrefix = settings['site.avatar_prefix'];
        if (currentPrefix && currentPrefix.includes('gravatar.com')) {
          console.log('Detecting legacy Gravatar setting, migrating to Cravatar...');

          // 3. 执行更新 (尝试调用 update 接口)
          // 注意：此接口通常需要登录态。如果当前用户未登录，此操作将失败（静默失败即可，下次管理员登录时会再次触发）
          const updateRes = await fetch('/api/settings', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              'site.avatar_prefix': 'https://www.cravatar.cn/avatar/'
            })
          });

          if (updateRes.ok) {
            console.log('Avatar source successfully migrated to Cravatar.cn');
            // 可选：提示用户刷新
            // alert('系统配置已优化，请刷新页面以应用最新的头像源。');
          }
        }
      } catch (e) {
        console.warn('Avatar migration check failed:', e);
      }
    })();

  </script>
</body>

</html>